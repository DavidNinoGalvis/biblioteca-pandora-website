generator client {
  provider = "prisma-client-js"
}

enum AgeGroup {
  A6_7
  A8_10
  A11_13
  A14_15
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  nickname  String    @unique
  firstName String?
  lastName  String?
  desescolarizado Boolean @default(false)
  hidden    Boolean   @default(false)
  ageGroup  AgeGroup?
  pin       String    // PIN encriptado
  role      String    @default("student") // "student" o "admin"
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  completedChallenges CompletedChallenge[]
  activeChallenge     ActiveChallenge?
  
  @@index([nickname])
  @@index([role])
}

model QuestionBank {
  id            String   @id @default(cuid())
  type          String   // "Matemáticas" o "Lectura crítica"
  question      String
  options       Json     // Array de strings ["opción 1", "opción 2", ...]
  correctAnswer Int      // Índice de la respuesta correcta (0-3)
  difficulty    String   @default("medium") // "easy", "medium", "hard"
  ageGroup      AgeGroup
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([type, active])
  @@index([difficulty])
}

model CompletedChallenge {
  id            String   @id @default(cuid())
  userId        String
  type          String   // "Matemáticas" o "Lectura crítica"
  question      String
  timeInSeconds Int
  isCorrect     Boolean
  ageGroup  AgeGroup?
  points        Int      @default(0)
  completedAt   DateTime @default(now())
  weekStart     DateTime // Para agrupar por semanas
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([weekStart])
  @@index([completedAt])
}

model ActiveChallenge {
  id            String   @id @default(cuid())
  userId        String   @unique
  type          String   // "Matemáticas" o "Lectura crítica"
  question      String
  options       Json     // Array de strings con las opciones
  correctAnswer Int      // Índice de la respuesta correcta
  startedAt     DateTime @default(now())
  createdAt     DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
}
